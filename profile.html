<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Profile</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif;
      background: #f0f2f5;
      display: flex; flex-direction: column;
    }
    header {
      background-color: #1877f2; color: white; padding: 1rem;
      font-size: 1.5rem; font-weight: bold;
      text-align: center;
    }
    main {
      flex: 1; overflow-y: auto; padding: 1rem; max-width: 600px; margin: auto; width: 100%;
    }
    .profile-header {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;
    }
    .profile-pic {
      width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
      background: #ccc;
      cursor: pointer;
      border: 3px solid #1877f2;
    }
    .profile-name {
      font-size: 1.8rem; font-weight: bold;
      flex-grow: 1;
    }
    .upload-input {
      display: none;
    }
    .new-post {
      margin-bottom: 1.5rem;
    }
    .new-post textarea {
      width: 100%; resize: vertical; min-height: 60px; padding: 0.5rem; font-size: 1rem;
    }
    .new-post button {
      margin-top: 0.5rem; background-color: #1877f2; border: none; color: white;
      padding: 0.5rem 1rem; font-size: 1rem; border-radius: 4px;
      cursor: pointer;
    }
    .posts-list {
      display: flex; flex-direction: column; gap: 1rem;
    }
    .post {
      background: white; padding: 1rem; border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
    }
    .post-text {
      margin-bottom: 0.5rem;
      white-space: pre-wrap;
      font-size: 1.1rem;
    }
    .post-time {
      font-size: 0.8rem; color: #666;
    }
    .delete-post-btn {
      position: absolute; top: 10px; right: 10px;
      background: transparent; border: none; cursor: pointer;
      font-size: 1.2rem; color: #e00;
    }
    nav.bottom-nav {
      display: flex; justify-content: space-around; align-items: center;
      background: white; box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
      padding: 0.5rem 0;
      position: fixed; bottom: 0; width: 100%; max-width: 600px; margin: auto;
      left: 0; right: 0;
    }
    nav.bottom-nav button {
      background: none; border: none; font-size: 1rem; color: #1877f2;
      cursor: pointer; display: flex; flex-direction: column; align-items: center;
      gap: 0.2rem;
    }
    nav.bottom-nav button:focus {
      outline: none;
      color: #0a52f5;
      font-weight: bold;
    }
    #settings-modal {
      position: fixed;
      bottom: -300px;
      left: 0; right: 0;
      max-width: 600px;
      margin: auto;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      padding: 1rem;
      transition: bottom 0.3s ease;
      z-index: 100;
    }
    #settings-modal.active {
      bottom: 0;
    }
    #settings-modal h2 {
      margin-top: 0; margin-bottom: 1rem;
      font-size: 1.2rem;
      text-align: center;
    }
    #settings-modal button {
      width: 100%; padding: 0.75rem; font-size: 1rem; margin-top: 0.5rem;
      border: none; border-radius: 6px; cursor: pointer;
    }
    #settings-modal .close-btn {
      background: #ddd; color: #333;
    }
    #settings-modal .logout-btn {
      background: #e00; color: white;
    }
  </style>
</head>
<body>

<header>User Profile</header>

<main>
  <div class="profile-header">
    <img src="https://www.gravatar.com/avatar/?d=mp&s=80" alt="Profile Picture" id="profilePic" class="profile-pic" title="Click to upload new profile picture" />
    <input type="file" id="profilePicUpload" class="upload-input" accept="image/*" />
    <div class="profile-name" id="profileName">Loading...</div>
  </div>

  <div class="new-post">
    <textarea id="newPostText" placeholder="What's on your mind?"></textarea>
    <button id="postBtn">Post</button>
  </div>

  <div id="postsList" class="posts-list">
    <!-- User posts will load here -->
  </div>
</main>

<nav class="bottom-nav">
  <button id="navProfileBtn" title="Profile">üë§ Profile</button>
  <button id="navHomeBtn" title="Home">üè† Home</button>
  <button id="navSettingsBtn" title="Settings">‚öôÔ∏è Settings</button>
</nav>

<div id="settings-modal">
  <h2>Settings</h2>
  <button id="editProfileBtn">Edit Profile (Coming Soon)</button>
  <button id="logoutBtn" class="logout-btn">Logout</button>
  <button id="closeSettingsBtn" class="close-btn">Close</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signOut,
  } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, query, where, onSnapshot,
    orderBy, deleteDoc, doc,
  } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
  import {
    getStorage, ref as storageRef, uploadBytes, getDownloadURL,
  } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-storage.js";

  // Your Firebase config from your previous info
  const firebaseConfig = {
    apiKey: "AIzaSyC7vwhzBfPYDGhZmi4hL9u9e1e6PfwC-84",
    authDomain: "socialwave-3e0b0.firebaseapp.com",
    projectId: "socialwave-3e0b0",
    storageBucket: "socialwave-3e0b0.appspot.com",
    messagingSenderId: "898231371609",
    appId: "1:898231371609:web:a5ecb830759cf86e96b812",
    measurementId: "G-W9MJ3XFTJ0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;

  const profilePic = document.getElementById('profilePic');
  const profilePicUpload = document.getElementById('profilePicUpload');
  const profileName = document.getElementById('profileName');
  const newPostText = document.getElementById('newPostText');
  const postBtn = document.getElementById('postBtn');
  const postsList = document.getElementById('postsList');

  const navProfileBtn = document.getElementById('navProfileBtn');
  const navHomeBtn = document.getElementById('navHomeBtn');
  const navSettingsBtn = document.getElementById('navSettingsBtn');

  const settingsModal = document.getElementById('settings-modal');
  const logoutBtn = document.getElementById('logoutBtn');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');

  // Show/hide settings modal
  navSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.add('active');
  });
  closeSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.remove('active');
  });

  // Logout
  logoutBtn.addEventListener('click', async () => {
    await signOut(auth);
    location.href = "index.html"; // Redirect to login or homepage after logout
  });

  // Profile pic upload flow
  profilePic.addEventListener('click', () => {
    profilePicUpload.click();
  });

  profilePicUpload.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const storageReference = storageRef(storage, `profile_pictures/${currentUser.uid}`);
    await uploadBytes(storageReference, file);
    const downloadURL = await getDownloadURL(storageReference);
    await currentUser.updateProfile({ photoURL: downloadURL }).catch(() => {});
    profilePic.src = downloadURL;
  });

  // Listen for auth state changes
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      loadUserProfile(user);
      loadUserPosts(user);
    } else {
      location.href = "index.html"; // redirect to login if not logged in
    }
  });

  // Load user profile info
  async function loadUserProfile(user) {
    profileName.textContent = user.displayName || "Anonymous";
    profilePic.src = user.photoURL || "https://www.gravatar.com/avatar/?d=mp&s=80";
  }

  // Load posts by user & listen for real-time updates
  function loadUserPosts(user) {
    const postsQuery = query(
      collection(db, "posts"),
      where("uid", "==", user.uid),
      orderBy("createdAt", "desc")
    );

    onSnapshot(postsQuery, snapshot => {
      postsList.innerHTML = "";
      snapshot.forEach(docSnap => {
        const post = docSnap.data();
        const postId = docSnap.id;
        const postElem = document.createElement("div");
        postElem.classList.add("post");

        const postText = document.createElement("div");
        postText.classList.add("post-text");
        postText.textContent = post.text;

        const postTime = document.createElement("div");
        postTime.classList.add("post-time");
        postTime.textContent = new Date(post.createdAt.toMillis()).toLocaleString();

        const deleteBtn = document.createElement("button");
        deleteBtn.classList.add("delete-post-btn");
        deleteBtn.textContent = "√ó";
        deleteBtn.title = "Delete post";
        deleteBtn.onclick = async () => {
          if (confirm("Delete this post?")) {
            await deleteDoc(doc(db, "posts", postId));
          }
        };

        postElem.appendChild(postText);
        postElem.appendChild(postTime);
        postElem.appendChild(deleteBtn);

        postsList.appendChild(postElem);
      });

      if (postsList.children.length === 0) {
        postsList.textContent = "No posts yet.";
      }
    });
  }

  // Post new post
  postBtn.addEventListener("click", async () => {
    const text = newPostText.value.trim();
    if (!text) return alert("Please write something.");

    await addDoc(collection(db, "posts"), {
      uid: currentUser.uid,
      text,
      createdAt: new Date()
    });

    newPostText.value = "";
  });

  // Navigation button placeholders
  navProfileBtn.addEventListener("click", () => {
    alert("You are already on Profile page.");
  });
  navHomeBtn.addEventListener("click", () => {
    location.href = "home.html"; // Change as needed
  });
</script>

</body>
</html>
